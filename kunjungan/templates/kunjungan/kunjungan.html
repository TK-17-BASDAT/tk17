{% extends "base.html" %}

{% block title %}Daftar Kunjungan - PetClinic{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden">
  {% include "navbar/sidebar.html" %}
  <main class="flex-1 ml-64 overflow-y-auto">
    <div class="bg-gray-300 min-h-screen p-6 flex font-[Poppins]">
      <div class="w-full bg-white rounded-xl shadow-md p-8">

        <!-- Main content -->
        <div class="flex-1 p-8">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-semibold text-primary">Daftar Kunjungan</h1>
                {% if request.session.user_role == 'front_desk' %}
                    <button type="button" id="create-kunjungan-btn" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                        + Buat Kunjungan Baru
                    </button>
                {% endif %}
            </div>

            <!-- Messages
            {% if messages %}
                <div class="mb-4">
                    {% for message in messages %}
                        <p class="text-{{ message.tags }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %} -->

            <!-- List Kunjungan -->
            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="table-auto w-full border-separate border-spacing-0">
                    <thead class="bg-primary text-white">
                        {% if request.session.user_role == 'front_desk' %}
                            <tr>
                                <th class="px-4 py-3 text-left">ID Kunjungan</th>
                                <th class="px-4 py-3 text-left">ID Klien</th>
                                <th class="px-4 py-3 text-left">Nama Hewan</th>
                                <th class="px-4 py-3 text-left">Metode</th>
                                <th class="px-4 py-3 text-left">Waktu Mulai</th>
                                <th class="px-4 py-3 text-left">Waktu Akhir</th>
                                <th class="px-4 py-3 text-left">Rekam Medis</th>
                                <th class="px-4 py-3 text-left">Action</th>
                            </tr>
                        {% else %}
                            <tr>
                                <th class="px-4 py-3 text-left">ID Kunjungan</th>
                                <th class="px-4 py-3 text-left">ID Klien</th>
                                <th class="px-4 py-3 text-left">Nama Hewan</th>
                                <th class="px-4 py-3 text-left">Metode</th>
                                <th class="px-4 py-3 text-left">Waktu Mulai</th>
                                <th class="px-4 py-3 text-left">Waktu Akhir</th>
                                <th class="px-4 py-3 text-left">Rekam Medis</th>
                            </tr>
                        {% endif %}
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for kunjungan in kunjungans %}
                            <tr>
                                {% if request.session.user_role == 'front_desk' %}
                                    <td class="px-4 py-3">{{ kunjungan.id_kunjungan }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.no_identitas_klien }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.nama_hewan }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.tipe_kunjungan }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.timestamp_awal|date:"d-m-Y H:i" }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.timestamp_akhir|date:"d-m-Y H:i" }}</td>
                                    <td class="px-4 py-3">
                                        <button type="button" data-id="{{ kunjungan.id_kunjungan }}" class="lihat-rekam-btn px-3 py-1 bg-secondary/30 text-black rounded hover:bg-gray-100 transition">
                                            Lihat Rekam Medis
                                        </button>
                                    </td>
                                    <td class="px-4 py-3 space-x-2">
                                        <button type="button" data-id="{{ kunjungan.id_kunjungan }}" class="update-kunjungan-btn px-3 py-1 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                            Update
                                        </button>
                                        <button type="button" data-id="{{ kunjungan.id_kunjungan }}" class="delete-kunjungan-btn px-3 py-1 bg-primary text-white rounded hover:bg-primary/80 transition">
                                            Hapus
                                        </button>
                                    </td>
                                {% else %}
                                    <td class="px-4 py-3">{{ kunjungan.id_kunjungan }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.no_identitas_klien }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.nama_hewan }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.tipe_kunjungan }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.timestamp_awal|date:"d-m-Y H:i" }}</td>
                                    <td class="px-4 py-3">{{ kunjungan.timestamp_akhir|date:"d-m-Y H:i" }}</td>
                                    <td class="px-4 py-3">
                                        <button type="button" data-id="{{ kunjungan.id_kunjungan }}" class="lihat-rekam-btn px-3 py-1 bg-secondary/30 text-black rounded hover:bg-gray-100 transition">
                                            Lihat Rekam Medis
                                        </button>
                                    </td>
                                {% endif %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{% if request.session.user_role == 'front_desk' %}8{% else %}7{% endif %}" class="px-4 py-3 text-center text-gray-500">Tidak ada data kunjungan.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Create Kunjungan Modal -->
            {% if request.session.user_role == 'front_desk' %}
                <div id="create-kunjungan-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-primary">Buat Kunjungan Baru</h2>
                        </div>
                        <form method="post" id="create-kunjungan-form" class="space-y-4">
                            {% csrf_token %}
                            <div>
                                <label for="no_identitas_klien" class="block text-sm font-medium text-gray-700">ID Klien</label>
                                <select name="no_identitas_klien" id="no_identitas_klien" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled selected>Pilih ID Klien</option>
                                    {% for klien in kliens %}
                                        <option value="{{ klien.no_identitas }}">{{ klien.no_identitas }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="nama_hewan" class="block text-sm font-medium text-gray-700">Nama Hewan</label>
                                <select name="nama_hewan" id="nama_hewan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled selected>Pilih Nama Hewan</option>
                                </select>
                            </div>
                            <div>
                                <label for="no_dokter_hewan" class="block text-sm font-medium text-gray-700">Email Dokter</label>
                                <select name="no_dokter_hewan" id="no_dokter_hewan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled selected>Pilih Dokter</option>
                                    {% for dokter in dokters %}
                                        <option value="{{ dokter.no_dokter_hewan }}">{{ dokter.email }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="no_perawat_hewan" class="block text-sm font-medium text-gray-700">Email Perawat</label>
                                <select name="no_perawat_hewan" id="no_perawat_hewan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled selected>Pilih Perawat</option>
                                    {% for perawat in perawats %}
                                        <option value="{{ perawat.no_perawat_hewan }}">{{ perawat.email }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="tipe_kunjungan" class="block text-sm font-medium text-gray-700">Metode</label>
                                <select name="tipe_kunjungan" id="tipe_kunjungan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled selected>Pilih metode</option>
                                    <option value="Janji Temu">Janji Temu</option>
                                    <option value="Walk-In">Walk-In</option>
                                    <option value="Darurat">Darurat</option>
                                </select>
                            </div>
                            <div>
                                <label for="timestamp_awal" class="block text-sm font-medium text-gray-700">Waktu Mulai</label>
                                <input type="datetime-local" name="timestamp_awal" id="timestamp_awal" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            </div>
                            <div>
                                <label for="timestamp_akhir" class="block text-sm font-medium text-gray-700">Waktu Akhir</label>
                                <input type="datetime-local" name="timestamp_akhir" id="timestamp_akhir" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                                    Create
                                </button>
                                <button type="button" id="create-cancel-button" class="px-4 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Update Kunjungan Modal -->
                <div id="update-kunjungan-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-primary">Update Kunjungan</h2>
                        </div>
                        <form method="post" id="update-kunjungan-form" class="space-y-4">
                            {% csrf_token %}
                            <input type="hidden" name="id_kunjungan" id="update_id_kunjungan">
                            <div>
                                <label for="update_no_identitas_klien" class="block text-sm font-medium text-gray-700">ID Klien</label>
                                <select name="no_identitas_klien" id="update_no_identitas_klien" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled>Pilih ID Klien</option>
                                    {% for klien in kliens %}
                                        <option value="{{ klien.no_identitas }}">{{ klien.no_identitas }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="update_nama_hewan" class="block text-sm font-medium text-gray-700">Nama Hewan</label>
                                <select name="nama_hewan" id="update_nama_hewan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled>Pilih Nama Hewan</option>
                                </select>
                            </div>
                            <div>
                                <label for="update_no_dokter_hewan" class="block text-sm font-medium text-gray-700">Email Dokter</label>
                                <select name="no_dokter_hewan" id="update_no_dokter_hewan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled>Pilih Dokter</option>
                                    {% for dokter in dokters %}
                                        <option value="{{ dokter.no_dokter_hewan }}">{{ dokter.email }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="update_no_perawat_hewan" class="block text-sm font-medium text-gray-700">Email Perawat</label>
                                <select name="no_perawat_hewan" id="update_no_perawat_hewan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled>Pilih Perawat</option>
                                    {% for perawat in perawats %}
                                        <option value="{{ perawat.no_perawat_hewan }}">{{ perawat.email }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="update_tipe_kunjungan" class="block text-sm font-medium text-gray-700">Metode</label>
                                <select name="tipe_kunjungan" id="update_tipe_kunjungan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                    <option value="" disabled>Pilih metode</option>
                                    <option value="Janji Temu">Janji Temu</option>
                                    <option value="Walk-In">Walk-In</option>
                                    <option value="Darurat">Darurat</option>
                                </select>
                            </div>
                            <div>
                                <label for="update_timestamp_awal" class="block text-sm font-medium text-gray-700">Waktu Mulai</label>
                                <input type="datetime-local" name="timestamp_awal" id="update_timestamp_awal" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            </div>
                            <div>
                                <label for="update_timestamp_akhir" class="block text-sm font-medium text-gray-700">Waktu Akhir</label>
                                <input type="datetime-local" name="timestamp_akhir" id="update_timestamp_akhir" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                                    Update
                                </button>
                                <button type="button" id="update-cancel-button" class="px-4 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delete Kunjungan Modal -->
                <div id="delete-kunjungan-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4 p-6">
                        <h2 class="text-2xl font-semibold text-primary mb-4">Delete Kunjungan</h2>
                        <p class="mb-4 text-gray-700" id="delete-kunjungan-message"></p>
                        <form method="post" id="delete-kunjungan-form" class="space-y-4">
                            {% csrf_token %}
                            <div class="flex justify-end space-x-4">
                                <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                                    Confirm Deletion
                                </button>
                                <button type="button" id="delete-cancel-button" class="px-4 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}

            <!-- Missing Modal (Rekam Medis Tidak Tersedia) -->
            <div id="missing-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4 p-6">
                    <h2 class="text-2xl font-semibold text-red-600 mb-4">Rekam Medis tidak Tersedia</h2>
                    <p class="mb-6 text-gray-700">Maaf, sepertinya belum ada rekam medis yang dibuat untuk kunjungan ini.</p>
                    {% if request.session.user_role == 'dokter_hewan' %}
                        <div class="flex justify-end space-x-4">
                            <button id="missing-create" class="px-6 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                                Buat
                            </button>
                            <button id="missing-ok" class="px-6 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                OK
                            </button>
                        </div>
                    {% else %}
                        <div class="flex justify-end">
                            <button id="missing-ok" class="px-6 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                OK
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Detail Modal (Rekam Medis) -->
            <div id="detail-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-primary">Rekam Medis</h2>
                    </div>
                    <div class="space-y-4 text-gray-800 mb-6" id="detail-content">
                        <div>
                            <h3 class="font-medium">Suhu Tubuh</h3>
                            <p id="detail-suhu">-</p>
                        </div>
                        <div>
                            <h3 class="font-medium">Berat Badan</h3>
                            <p id="detail-berat">-</p>
                        </div>
                        <div>
                            <h3 class="font-medium">Catatan Medis</h3>
                            <p id="detail-catatan">-</p>
                        </div>
                    </div>
                    {% if request.session.user_role == 'dokter_hewan' %}
                        <div class="flex justify-end space-x-4">
                            <button id="detail-update" class="px-6 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                                Update
                            </button>
                            <button id="detail-close" class="px-6 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                Close
                            </button>
                        </div>
                    {% else %}
                        <div class="flex justify-end">
                            <button id="detail-close" class="px-6 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                Close
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>


            <!-- Create Rekam Medis Modal -->
            <div id="create-rekam-medis-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-primary">Create Rekam Medis</h2>
                    </div>
                    <form method="post" id="create-rekam-medis-form" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="id_kunjungan" id="create_id_kunjungan">
                        <div>
                            <label for="suhu" class="block text-sm font-medium text-gray-700">Suhu Tubuh Pasien (°C)</label>
                            <input type="number" step="0.1" name="suhu" id="suhu" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="berat_badan" class="block text-sm font-medium text-gray-700">Berat Badan Pasien (kg)</label>
                            <input type="number" step="0.1" name="berat_badan" id="berat_badan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="catatan" class="block text-sm font-medium text-gray-700">Catatan Medis</label>
                            <textarea name="catatan" id="catatan" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></textarea>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                                Create
                            </button>
                            <button type="button" id="create-rekam-cancel" class="px-4 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Update Rekam Medis Modal -->
            <div id="update-rekam-medis-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
                <div class="bg-white rounded-lg shadow-lg max-w-lg w-full mx-4 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-primary">Update Rekam Medis</h2>
                    </div>
                    <form method="post" id="update-rekam-medis-form" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="id_kunjungan" id="update_id_kunjungan">
                        <div>
                            <label for="update_suhu" class="block text-sm font-medium text-gray-700">Suhu Tubuh Pasien (°C)</label>
                            <input type="number" step="0.1" name="suhu" id="update_suhu" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="update_berat_badan" class="block text-sm font-medium text-gray-700">Berat Badan Pasien (kg)</label>
                            <input type="number" step="0.1" name="berat_badan" id="update_berat_badan" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="update_catatan" class="block text-sm font-medium text-gray-700">Catatan Medis</label>
                            <textarea name="catatan" id="update_catatan" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></textarea>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/80 transition">
                                Update
                            </button>
                            <button type="button" id="update-rekam-cancel" class="px-4 py-2 bg-secondary text-white rounded hover:bg-secondary/80 transition">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
  </main>
</div>

<!-- Definisikan userRole untuk digunakan di JavaScript -->
<script>
    const userRole = "{{ request.session.user_role|escapejs }}";
</script>

<script>
    
    let currentIdKunjungan = null;
    document.querySelectorAll('.lihat-rekam-btn').forEach(button => {
        button.addEventListener('click', async () => {
            currentIdKunjungan = button.getAttribute('data-id');
            try {
                const response = await fetch(`/kunjungan/rekam-medis/check/${currentIdKunjungan}/`);
                const data = await response.json();
                
                if (data.exists) {
                    
                    document.getElementById('detail-suhu').textContent = data.suhu + ' °C';
                    document.getElementById('detail-berat').textContent = data.berat_badan + ' kg';
                    document.getElementById('detail-catatan').textContent = data.catatan || 'Tidak ada catatan';
                    document.getElementById('detail-modal').classList.remove('hidden');
                } else {
                    
                    document.getElementById('missing-modal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan: ' + error.message);
            }
        });
    });


    
    document.getElementById('missing-ok').addEventListener('click', () => {
        document.getElementById('missing-modal').classList.add('hidden');
    });
    document.getElementById('missing-create')?.addEventListener('click', () => {
        if (userRole === 'dokter_hewan') {
            document.getElementById('missing-modal').classList.add('hidden');
            if (!currentIdKunjungan) {
                alert('ID Kunjungan tidak ditemukan. Silakan coba lagi.');
                return;
            }
            document.getElementById('create_id_kunjungan').value = currentIdKunjungan; 
            document.getElementById('create-rekam-medis-modal').classList.remove('hidden');
        } else {
            alert('Hanya dokter yang dapat membuat rekam medis.');
        }
    });

    
    document.getElementById('detail-close').addEventListener('click', () => {
        document.getElementById('detail-modal').classList.add('hidden');
    });
    document.getElementById('detail-update')?.addEventListener('click', async () => {
        if (userRole === 'dokter_hewan') {
            document.getElementById('detail-modal').classList.add('hidden');
            if (!currentIdKunjungan) {
                alert('ID Kunjungan tidak ditemukan. Silakan coba lagi.');
                return;
            }
            try {
                
                const response = await fetch(`/kunjungan/rekam-medis/check/${currentIdKunjungan}/`);
                const data = await response.json();
                document.getElementById('update_id_kunjungan').value = currentIdKunjungan;
                document.getElementById('update_suhu').value = data.suhu || '';
                document.getElementById('update_berat_badan').value = data.berat_badan || '';
                document.getElementById('update_catatan').value = data.catatan || '';
                document.getElementById('update-rekam-medis-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengambil data rekam medis.');
            }
        } else {
            alert('Hanya dokter yang dapat memperbarui rekam medis.');
        }
    });

    
    document.getElementById('create-rekam-cancel').addEventListener('click', () => {
        document.getElementById('create-rekam-medis-modal').classList.add('hidden');
    });
    document.getElementById('create-rekam-medis-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (userRole === 'dokter_hewan') {
            const form = e.target;
            const idKunjungan = document.getElementById('create_id_kunjungan').value;
            try {
                
                const response = await fetch(`/kunjungan/rekam-medis/create/${idKunjungan}/`, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
                    }
                });
                if (response.ok) {
                    document.getElementById('create-rekam-medis-modal').classList.add('hidden');
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    console.error('Error creating rekam medis:', errorData);
                    alert('Gagal membuat rekam medis: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Terjadi kesalahan jaringan saat membuat rekam medis.');
            }
        } else {
            alert('Hanya dokter yang dapat membuat rekam medis.');
        }
    });

    
    document.getElementById('update-rekam-cancel').addEventListener('click', () => {
        document.getElementById('update-rekam-medis-modal').classList.add('hidden');
    });
    document.getElementById('update-rekam-medis-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (userRole === 'dokter_hewan') {
            const form = e.target;
            const idKunjungan = document.getElementById('update_id_kunjungan').value;
            try {
                
                const response = await fetch(`/kunjungan/rekam-medis/update/${idKunjungan}/`, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
                    }
                });
                if (response.ok) {
                    document.getElementById('update-rekam-medis-modal').classList.add('hidden');
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    console.error('Error updating rekam medis:', errorData);
                    alert('Gagal memperbarui rekam medis: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Terjadi kesalahan jaringan saat memperbarui rekam medis.');
            }
        } else {
            alert('Hanya dokter yang dapat memperbarui rekam medis.');
        }
    });

    
    document.getElementById('create-kunjungan-btn')?.addEventListener('click', () => {
        document.getElementById('create-kunjungan-modal').classList.remove('hidden');
    });
    document.getElementById('create-cancel-button')?.addEventListener('click', () => {
        document.getElementById('create-kunjungan-modal').classList.add('hidden');
    });

    
    document.getElementById('create-kunjungan-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (userRole === 'front_desk') {
            const form = e.target;
            try {
                const response = await fetch('/kunjungan/create/', {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('create-kunjungan-modal').classList.add('hidden');
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    console.error('Error creating kunjungan:', errorData);
                    alert('Gagal membuat kunjungan: ' + (errorData.message || 'Periksa input data atau hubungi admin.'));
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Terjadi kesalahan jaringan saat membuat kunjungan.');
            }
        } else {
            alert('Hanya front desk yang dapat membuat kunjungan.');
        }
    });

    
    document.querySelectorAll('.update-kunjungan-btn').forEach(button => {
        button.addEventListener('click', async () => {
            if (userRole === 'front_desk') {
                const idKunjungan = button.getAttribute('data-id');
                try {
                    const response = await fetch(`/kunjungan/data/${idKunjungan}/`);
                    if (!response.ok) {
                        throw new Error('Gagal mengambil data kunjungan');
                    }
                    const data = await response.json();
                    document.getElementById('update_id_kunjungan').value = idKunjungan;
                    document.getElementById('update_no_identitas_klien').value = data.no_identitas_klien || '';
                    document.getElementById('update_no_dokter_hewan').value = data.no_dokter_hewan || '';
                    document.getElementById('update_no_perawat_hewan').value = data.no_perawat_hewan || '';
                    document.getElementById('update_tipe_kunjungan').value = data.tipe_kunjungan || '';
                    document.getElementById('update_timestamp_awal').value = data.timestamp_awal ? new Date(data.timestamp_awal).toISOString().slice(0, 16) : '';
                    document.getElementById('update_timestamp_akhir').value = data.timestamp_akhir ? new Date(data.timestamp_akhir).toISOString().slice(0, 16) : '';

                    const hewanResponse = await fetch(`/kunjungan/get-hewan/?no_identitas_klien=${data.no_identitas_klien}`);
                    if (!hewanResponse.ok) {
                        throw new Error('Gagal mengambil data hewan');
                    }
                    const hewanData = await hewanResponse.json();
                    const namaHewanSelect = document.getElementById('update_nama_hewan');
                    namaHewanSelect.innerHTML = '<option value="" disabled>Pilih Nama Hewan</option>';
                    hewanData.hewan.forEach(hewan => {
                        const option = document.createElement('option');
                        option.value = hewan.nama;
                        option.textContent = hewan.nama;
                        if (hewan.nama === data.nama_hewan) option.selected = true;
                        namaHewanSelect.appendChild(option);
                    });
                    document.getElementById('update-kunjungan-modal').classList.remove('hidden');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat mengambil data kunjungan: ' + error.message);
                }
            } else {
                alert('Hanya front desk yang dapat memperbarui kunjungan.');
            }
        });
    });
    document.getElementById('update-cancel-button')?.addEventListener('click', () => {
        document.getElementById('update-kunjungan-modal').classList.add('hidden');
    });

    
    document.getElementById('update-kunjungan-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (userRole === 'front_desk') {
            const form = e.target;
            const idKunjungan = document.getElementById('update_id_kunjungan').value;
            try {
                const response = await fetch(`/kunjungan/update/${idKunjungan}/`, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('update-kunjungan-modal').classList.add('hidden');
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    console.error('Error updating kunjungan:', errorData);
                    alert('Gagal memperbarui kunjungan: ' + (errorData.message || 'Periksa input data atau hubungi admin.'));
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Terjadi kesalahan jaringan saat memperbarui kunjungan.');
            }
        } else {
            alert('Hanya front desk yang dapat memperbarui kunjungan.');
        }
    });

    
    document.querySelectorAll('.delete-kunjungan-btn').forEach(button => {
        button.addEventListener('click', () => {
            if (userRole === 'front_desk') {
                const idKunjungan = button.getAttribute('data-id');
                document.getElementById('delete-kunjungan-message').innerHTML = `Apakah kamu yakin untuk menghapus KUNJUNGAN dengan ID <span class="font-medium">${idKunjungan}</span>?`;
                const form = document.getElementById('delete-kunjungan-form');
                form.action = `/kunjungan/delete/${idKunjungan}/`;
                document.getElementById('delete-kunjungan-modal').classList.remove('hidden');
            } else {
                alert('Hanya front desk yang dapat menghapus kunjungan.');
            }
        });
    });
    document.getElementById('delete-cancel-button')?.addEventListener('click', () => {
        document.getElementById('delete-kunjungan-modal').classList.add('hidden');
    });

    
    document.getElementById('delete-kunjungan-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (userRole === 'front_desk') {
            const form = e.target;
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('delete-kunjungan-modal').classList.add('hidden');
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    console.error('Error deleting kunjungan:', errorData);
                    alert('Gagal menghapus kunjungan: ' + (errorData.message || 'Periksa input data atau hubungi admin.'));
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Terjadi kesalahan jaringan saat menghapus kunjungan.');
            }
        } else {
            alert('Hanya front desk yang dapat menghapus kunjungan.');
        }
    });

    
    document.getElementById('no_identitas_klien')?.addEventListener('change', async (e) => {
        const noIdentitasKlien = e.target.value;
        try {
            const response = await fetch(`/kunjungan/get-hewan/?no_identitas_klien=${noIdentitasKlien}`);
            if (!response.ok) {
                throw new Error('Gagal mengambil data hewan');
            }
            const data = await response.json();
            const namaHewanSelect = document.getElementById('nama_hewan');
            namaHewanSelect.innerHTML = '<option value="" disabled selected>Pilih Nama Hewan</option>';
            data.hewan.forEach(hewan => {
                const option = document.createElement('option');
                option.value = hewan.nama;
                option.textContent = hewan.nama;
                namaHewanSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengambil daftar hewan: ' + error.message);
        }
    });

    
    document.getElementById('update_no_identitas_klien')?.addEventListener('change', async (e) => {
        const noIdentitasKlien = e.target.value;
        try {
            const response = await fetch(`/kunjungan/get-hewan/?no_identitas_klien=${noIdentitasKlien}`);
            if (!response.ok) {
                throw new Error('Gagal mengambil data hewan');
            }
            const data = await response.json();
            const namaHewanSelect = document.getElementById('update_nama_hewan');
            namaHewanSelect.innerHTML = '<option value="" disabled selected>Pilih Nama Hewan</option>';
            data.hewan.forEach(hewan => {
                const option = document.createElement('option');
                option.value = hewan.nama;
                option.textContent = hewan.nama;
                namaHewanSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengambil daftar hewan: ' + error.message);
        }
    });
</script>
{% endblock %}