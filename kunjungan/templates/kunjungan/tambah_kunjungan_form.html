

{% comment %} tk17/kunjungan/templates/kunjungan/tambah_kunjungan_form.html {% endcomment %} <div class="container mx-auto px-4 py-2"> <h2 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200"> Tambah Kunjungan Baru </h2> <form method="post" clas

pasted


# tk17/kunjungan/views.py from django.shortcuts import render, redirect from django.db import connection from django.http import Http404 import uuid # Jika kamu menggunakan tipe UUID di Python, meskipun di query bisa string # Helper function untuk mengubah hasil query cursor menjadi list of d

pasted

tambah_kunjungan_form.html
ini pas aku mau nambahin kunjunga form simpan kunjungan kenapa ya dia ga nambahin padahal harusnya masuk ke database tabel kunjungan

Saya melihat beberapa masalah potensial dalam kode Anda yang bisa menyebabkan form tidak menyimpan data ke database. Mari kita analisis masalahnya:

Masalah yang Teridentifikasi:
1. Missing Front Desk Selection di Form HTML
Di file tambah_kunjungan_form.html, Anda tidak memiliki field untuk memilih Front Desk, padahal di views.py ada parameter front_desk_id = request.POST.get('front_desk') yang dibutuhkan.

2. Inconsistent Field Names
Di HTML form, field dokter dan perawat menggunakan value dari no_dokter_hewan dan no_perawat_hewan, tapi di views.py Anda mengambil dengan nama yang berbeda.

3. Potential Database Constraint Issues
Kemungkinan ada constraint di database yang tidak terpenuhi.

Solusi:

Fixed Tambah Kunjungan Form
Interactive artifact 
Sekarang, mari kita juga perbaiki bagian views.py untuk debugging yang lebih baik:


Fixed Tambah Kunjungan View
Code 



oh front desk nya ituu sebnernya otomatis dari log in gitu bisa gaa soalnnya yang bisa nambahin kunjungan ini cuma front desk

Ah, iya betul! Jika yang bisa menambahkan kunjungan hanya Front Desk dan mereka sudah login, maka front desk ID bisa diambil otomatis dari session/user yang sedang login. Ini lebih masuk akal dari segi business logic.

Mari kita perbaiki kode-nya:


Fixed Tambah Kunjungan Form
Interactive artifact 

Fixed Tambah Kunjungan Form
Interactive artifact 
Sekarang mari kita perbaiki bagian views.py untuk mendapatkan front desk dari user yang sedang login:


Fixed Tambah Kunjungan View (Final)
Code 
Sekarang, ada beberapa hal yang perlu diperhatikan untuk debugging lebih lanjut:

Kemungkinan Masalah dan Solusi:
1. Cek Struktur Database
Pastikan tabel KUNJUNGAN memiliki struktur yang sesuai. Anda bisa cek dengan query ini:

sql
\d KUNJUNGAN
-- atau
DESCRIBE KUNJUNGAN;
2. Cek Constraint dan Foreign Key
Masalah yang sering terjadi adalah constraint yang tidak terpenuhi. Coba jalankan query berikut untuk memastikan data yang akan diinsert valid:

sql
-- Cek apakah klien exists
SELECT * FROM KLIEN WHERE no_identitas = 'your_klien_id';

-- Cek apakah hewan exists untuk klien tersebut
SELECT * FROM HEWAN WHERE nama = 'nama_hewan' AND no_identitas_klien = 'klien_id';

-- Cek apakah dokter exists
SELECT * FROM DOKTER_HEWAN WHERE no_dokter_hewan = 'dokter_id';

-- Cek apakah perawat exists
SELECT * FROM PERAWAT_HEWAN WHERE no_perawat_hewan = 'perawat_id';

-- Cek apakah front desk exists
SELECT * FROM FRONT_DESK WHERE no_front_desk = 'front_desk_id';
3. Debug dengan Django Shell
Untuk debugging lebih mendalam, bisa menggunakan Django shell:

bash
python manage.py shell
python
from django.db import connection

# Test query manual
with connection.cursor() as cursor:
    cursor.execute("SELECT COUNT(*) FROM KUNJUNGAN")
    print(cursor.fetchone())
4. Cek Django Settings
Pastikan di settings.py Anda memiliki:

python
DATABASES = {
    'default': {
        # ... konfigurasi database
        'AUTOCOMMIT': True,  # Pastikan ini True atau tidak ada
    }
}
5. Tambahkan Logging
Untuk melihat query SQL yang dijalankan, tambahkan ini di settings.py:

python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django.db.backends': {
            'handlers': ['console'],
            'level': 'DEBUG',
        },
    },
}
Coba implementasikan perubahan di atas dan test lagi. Jika masih bermasalah, periksa:

Apakah ada error di console browser?
Apakah ada error di Django console/logs?
Apakah form benar-benar mengirim POST request?
Apakah data yang dikirim sudah benar?
Beri tahu sa





{% comment %} tk17/kunjungan/templates/kunjungan/tambah_kunjungan_form.html {% endcomment %}

<div class="container mx-auto px-4 py-2">
    <h2 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">
        Tambah Kunjungan Baru
    </h2>

    <!-- Display Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-3 rounded-md {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" class="space-y-4" id="tambahKunjunganForm">
        {% csrf_token %}
        
        <!-- ID Klien -->
        <div>
            <label for="klien" class="block text-sm font-medium text-gray-700 mb-1">
                ID Klien yang mendaftarkan pasien <span class="text-red-500">*</span>
            </label>
            <select id="klien" name="klien" required 
                    class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-slate-500 focus:border-slate-500">
                <option value="">Pilih ID Klien</option>
                {% for klien in klien_list %}
                    <option value="{{ klien.no_identitas }}">{{ klien.no_identitas }} - {{ klien.nama_klien }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Email Dokter Hewan -->
        <div>
            <label for="dokter" class="block text-sm font-medium text-gray-700 mb-1">
                Email Dokter Hewan yang akan menangani <span class="text-red-500">*</span>
            </label>
            <select id="dokter" name="dokter" required 
                    class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-slate-500 focus:border-slate-500">
                <option value="">Pilih Dokter Hewan</option>
                {% for dokter in dokter_list %}
                    <option value="{{ dokter.no_dokter_hewan }}">{{ dokter.email_dokter }} - {{ dokter.info_kontak }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Email Perawat -->
        <div>
            <label for="perawat" class="block text-sm font-medium text-gray-700 mb-1">
                Email Perawat yang akan menangani <span class="text-red-500">*</span>
            </label>
            <select id="perawat" name="perawat" required 
                    class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-slate-500 focus:border-slate-500">
                <option value="">Pilih Perawat</option>
                {% for perawat in perawat_list %}
                    <option value="{{ perawat.no_perawat_hewan }}">{{ perawat.email_perawat }} - {{ perawat.info_kontak }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Front Desk Info (Read-only, from logged in user) -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
                Front Desk yang menangani
            </label>
            <div class="w-full border border-gray-200 rounded-md p-2 text-sm bg-gray-50">
                {{ current_front_desk.email_front_desk }} - {{ current_front_desk.nama_front_desk }}
                <span class="text-xs text-gray-500">(Otomatis dari akun yang login)</span>
            </div>
        </div>

        <!-- Nama Hewan -->
        <div>
            <label for="nama_hewan" class="block text-sm font-medium text-gray-700 mb-1">
                Nama Hewan yang didaftarkan oleh klien <span class="text-red-500">*</span>
            </label>
            <select id="nama_hewan" name="nama_hewan" required disabled
                    class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-slate-500 focus:border-slate-500 disabled:bg-gray-100">
                <option value="">Pilih klien terlebih dahulu</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Nama hewan yang tersedia pada dropdown menu adalah hewan yang didaftarkan/dimiliki oleh Klien yang dipilih pada menu sebelumnya (list nama hewan berubah bergantung pada ID Klien yang dipilih)</p>
        </div>

        <!-- Tiga metode kunjungan -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tiga metode kunjungan <span class="text-red-500">*</span></label>
            <div class="space-y-2">
                <label class="flex items-center">
                    <input type="radio" name="tipe_kunjungan" value="Janji Temu" required class="mr-2">
                    <span class="text-sm">Janji Temu (melalui reservasi)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="tipe_kunjungan" value="Walk-in" required class="mr-2">
                    <span class="text-sm">Walk-in (datang langsung)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="tipe_kunjungan" value="Darurat" required class="mr-2">
                    <span class="text-sm">Darurat (penanganan segera)</span>
                </label>
            </div>
        </div>

        <!-- Waktu mulai dan akhir -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="waktu_mulai" class="block text-sm font-medium text-gray-700 mb-1">
                    Waktu mulai penanganan <span class="text-red-500">*</span>
                </label>
                <input type="datetime-local" id="waktu_mulai" name="waktu_mulai" required
                       class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-slate-500 focus:border-slate-500">
                <p class="text-xs text-gray-500 mt-1">(terdiri dari tanggal dan jamnya)</p>
            </div>
            <div>
                <label for="waktu_akhir" class="block text-sm font-medium text-gray-700 mb-1">
                    Waktu akhir penanganan
                </label>
                <input type="datetime-local" id="waktu_akhir" name="waktu_akhir"
                       class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-slate-500 focus:border-slate-500">
                <p class="text-xs text-gray-500 mt-1">(opsional, bisa diisi nanti)</p>
            </div>
        </div>

        <div class="flex justify-end pt-4 space-x-2">
            <button type="button" class="modal-close-button-secondary bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm">
                Batal
            </button>
            <button type="submit" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-md text-sm">
                Simpan Kunjungan
            </button>
        </div>
    </form>
</div>

<script>
// Script untuk mengambil daftar hewan berdasarkan klien yang dipilih
document.getElementById('klien').addEventListener('change', function() {
    const klienId = this.value;
    const hewanSelect = document.getElementById('nama_hewan');
    
    if (klienId) {
        hewanSelect.disabled = true;
        hewanSelect.innerHTML = '<option value="">Loading...</option>';
        
        // Gunakan URL yang sama dengan parameter GET
        fetch(`?klien_id=${klienId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                hewanSelect.innerHTML = '<option value="">Pilih Hewan</option>';
                if (data.hewan_list && data.hewan_list.length > 0) {
                    data.hewan_list.forEach(hewan => {
                        hewanSelect.innerHTML += `<option value="${hewan.nama}">${hewan.nama}</option>`;
                    });
                } else {
                    hewanSelect.innerHTML += '<option value="">Tidak ada hewan terdaftar</option>';
                }
                hewanSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                hewanSelect.innerHTML = '<option value="">Error loading data</option>';
                hewanSelect.disabled = false;
            });
    } else {
        hewanSelect.innerHTML = '<option value="">Pilih klien terlebih dahulu</option>';
        hewanSelect.disabled = true;
    }
});

// Debug form submission
document.getElementById('tambahKunjunganForm').addEventListener('submit', function(e) {
    console.log('Form is being submitted...');
    
    // Check if all required fields are filled
    const requiredFields = ['klien', 'dokter', 'perawat', 'nama_hewan', 'tipe_kunjungan', 'waktu_mulai'];
    const missingFields = [];
    
    requiredFields.forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (!field || !field.value) {
            missingFields.push(fieldName);
        }
    });
    
    if (missingFields.length > 0) {
        console.error('Missing required fields:', missingFields);
        alert('Harap lengkapi semua field yang diperlukan: ' + missingFields.join(', '));
        e.preventDefault();
        return false;
    }
    
    console.log('All required fields are filled');
});
</script>

