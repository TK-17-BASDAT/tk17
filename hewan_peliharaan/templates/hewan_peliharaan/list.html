{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="flex">
  {% include "navbar/sidebar.html" %}
  <main class="bg-gray-50 flex-1 ml-64 p-6">
    <div class="bg-gray-50 min-h-screen flex items-center justify-center p-6 font-[Poppins]">
      <div class="container mx-auto">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-semibold">List Hewan Peliharaan</h1>
          <button id="btn-create"
                  class="bg-primary text-white px-4 py-2 rounded hover:bg-secondary transition">
            + Create New Pet
          </button>
        </div>
  
        <table class="w-full table-auto border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-4 py-2 border">No</th>
              <th class="px-4 py-2 border">Pemilik</th>
              <th class="px-4 py-2 border">Jenis Hewan</th>
              <th class="px-4 py-2 border">Nama Hewan</th>
              <th class="px-4 py-2 border">Tanggal Lahir</th>
              <th class="px-4 py-2 border">Foto</th>
              <th class="px-4 py-2 border">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for hewan in hewan_list %}
            <tr class="border-b">
              <td class="px-4 py-2">{{ hewan.counter }}</td>
              <td class="px-4 py-2">{{ hewan.nama_pemilik }}</td>
              <td class="px-4 py-2">{{ hewan.jenis_hewan }}</td>
              <td class="px-4 py-2">{{ hewan.nama_hewan }}</td>
              <td class="px-4 py-2">{{ hewan.tanggal_lahir_formatted }}</td>
              <td class="px-4 py-2">
                <img src="{{ hewan.url_foto }}" class="w-12 h-12 rounded object-cover">
              </td>
              <td class="px-4 py-2 space-x-1">
                <button class="btn-update bg-secondary text-white px-3 py-1 rounded hover:bg-primary transition text-sm"
                        data-url="{% url 'hewan_peliharaan:update' hewan.id %}">
                  Update
                </button>
                {% if request.session.user_role == 'front_desk' and hewan.can_delete %}
                <button class="btn-delete bg-accent text-white px-3 py-1 rounded hover:bg-accent2 transition text-sm"
                        data-url="{% url 'hewan_peliharaan:delete' hewan.id %}">
                  Delete
                </button>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="px-4 py-2 text-center text-gray-500">No pets found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  
      <!-- Modal container -->
      <div id="modal"
          class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-1/3 p-6"></div>
      </div>
  
      <script>
      document.addEventListener('DOMContentLoaded', () => {
        const modal    = document.getElementById('modal'),
              content  = document.getElementById('modal-content');
  
        function openModal(html){
          content.innerHTML = html;
          modal.classList.remove('hidden');
        }
        function closeModal(){
          modal.classList.add('hidden');
          content.innerHTML = '';
        }
  
        // Create button
        document.getElementById('btn-create').addEventListener('click', ()=>{
          fetch("{% url 'hewan_peliharaan:create' %}")
            .then(r => r.text())
            .then(openModal);
        });
  
        // Update buttons
        document.querySelectorAll('.btn-update').forEach(btn=>{
          btn.onclick = ()=> fetch(btn.dataset.url).then(r=>r.text()).then(openModal);
        });
        
        // Delete buttons (only for front desk)
        document.querySelectorAll('.btn-delete').forEach(btn=>{
          btn.onclick = ()=> fetch(btn.dataset.url).then(r=>r.text()).then(openModal);
        });
  
        // AJAX form submit
        modal.addEventListener('submit', e=>{
          e.preventDefault();
          const form = e.target,
                data = new FormData(form);
          fetch(form.action, {
            method: form.method,
            headers: {'X-Requested-With':'XMLHttpRequest'},
            body: data
          })
          .then(r => r.json())
          .then(json => {
            if(json.success){
              location.reload();
            } else {
              content.innerHTML = json.html;
            }
          });
        });
  
        // Cancel/error OK
        modal.addEventListener('click', e=>{
          if(e.target===modal || e.target.classList.contains('btn-cancel')){
            closeModal();
          }
        });
      });
        </script>
      </div>

    </div>
  </main>
</div>
{% endblock %}